{% extends "base.html" %}
{% load static %}
{% block title %}Вход{% endblock %}

{% block content %}
  <div class="max-w-md mx-auto bg-white/10 rounded-2xl border border-white/20 p-6 shadow-xl">
    <h1 class="text-2xl font-semibold mb-6">Вход в систему</h1>

    <form id="loginForm" class="space-y-4" autocomplete="on">
      <div>
        <label class="block text-sm text-white/80 mb-1">Логин</label>
        <input name="username" type="text" required
               class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 outline-none focus:ring-2 focus:ring-white/30" />
      </div>

      <div>
        <label class="block text-sm text-white/80 mb-1">Пароль</label>
        <input name="password" type="password" required
               class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/20 outline-none focus:ring-2 focus:ring-white/30" />
        <!-- Блок ошибок под паролем -->
        <p id="loginError" class="mt-2 text-sm text-red-300 hidden"></p>
      </div>

      <button id="loginBtn" type="submit"
              class="w-full py-2 rounded-lg bg-white/20 hover:bg-white/30 border border-white/30 font-semibold transition disabled:opacity-60">
        Войти
      </button>
    </form>
  </div>
{% endblock %}

{% block body_extra %}
<script>
  $("#loginForm").on("submit", function(e){
    e.preventDefault();
    const $btn = $("#loginBtn");
    const $err = $("#loginError").addClass("hidden").text("");

    $btn.prop("disabled", true).text("Входим...");

    const payload = {
      username: $.trim($("input[name='username']").val()),
      password: $("input[name='password']").val()
    };

    $.ajax({
      url: "{% url 'api_login' %}",
      method: "POST",
      data: JSON.stringify(payload),
      contentType: "application/json; charset=utf-8",
      headers: { "X-CSRFToken": csrftoken() },
      success: function(){
        window.location.href = "{{ request.GET.next|default:'/' }}";
      },
      error: function(xhr){
        let msg = "Ошибка входа";
        if (xhr.status >= 500) {
          msg = `Ошибка сервера (код ${xhr.status})`;
        } else if (xhr.responseJSON && xhr.responseJSON.detail) {
          msg = xhr.responseJSON.detail;
        } else if (xhr.status === 0) {
          msg = "Нет соединения с сервером";
        } else {
          msg = `Не удалось войти (код ${xhr.status})`;
        }
        $err.text(msg).removeClass("hidden");
      },
      complete: function(){
        $btn.prop("disabled", false).text("Войти");
      }
    });
  });
</script>
{% endblock %}
